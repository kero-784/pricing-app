<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Expiry Report</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <style>
        /* Your existing CSS remains the same, just adding scanner styles */
        
        /* Barcode Scanner Styles */
        #scanner-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.9); z-index: 10000;
            display: none; justify-content: center; align-items: center;
            flex-direction: column;
        }
        #scanner-modal.visible { display: flex; }
        .scanner-container {
            background-color: white; border-radius: var(--border-radius);
            padding: 24px; max-width: 500px; width: 90%;
            box-shadow: var(--shadow-md); text-align: center;
            margin-bottom: 20px;
        }
        #scanner-canvas { width: 100%; max-width: 400px; height: auto; }
        #scanner-video {
            width: 100%; max-width: 400px; height: 300px;
            border-radius: 8px; background-color: #000;
            object-fit: cover;
        }
        .scanner-controls {
            display: flex; gap: 12px; justify-content: center;
            margin-top: 16px; flex-wrap: wrap;
        }
        #scanner-status {
            margin-top: 12px; padding: 12px; border-radius: 8px;
            background-color: #f8f9fa; font-size: 0.9rem;
            min-height: 50px; display: flex; align-items: center; justify-content: center;
        }
        #scanner-status.scanning { background-color: var(--accent-highlight); color: var(--accent-success); }
        #scanner-status.error { background-color: #f8d7da; color: var(--accent-danger); }
        #scanner-status.success { background-color: #d1edff; color: var(--accent-primary); }
        
        .scanner-guide {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 250px; height: 150px; border: 2px solid #00ff00; border-radius: 8px;
            pointer-events: none; z-index: 1;
        }
        .scanner-guide::before {
            content: 'Align barcode within this area';
            position: absolute; top: -30px; left: 0; width: 100%; text-align: center;
            color: #00ff00; font-size: 0.8rem;
        }
        
        .camera-permission-help {
            background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;
            padding: 16px; margin-top: 16px; text-align: left;
        }
        .camera-permission-help h4 { margin-top: 0; color: #856404; }
        .camera-permission-help ul { margin-bottom: 0; padding-left: 20px; }
        .camera-permission-help li { margin-bottom: 8px; }

        @media (max-width: 600px) {
            .scanner-container { padding: 16px; }
            #scanner-video { height: 250px; }
            .scanner-guide { width: 200px; height: 120px; }
        }
    </style>
</head>
<body>
    <div id="loader-overlay"><div style="text-align:center;"><div class="spinner"></div><p id="loader-text">Initializing...</p></div></div>
    <div id="toast"></div>
    
    <!-- Barcode Scanner Modal -->
    <div id="scanner-modal">
        <div class="scanner-container">
            <h2 style="margin-top: 0;">Scan Barcode</h2>
            <div id="scanner-area" style="position: relative;">
                <video id="scanner-video" playsinline autoplay></video>
                <canvas id="scanner-canvas" style="display: none;"></canvas>
                <div class="scanner-guide"></div>
            </div>
            <div id="scanner-status">Preparing camera...</div>
            
            <div class="camera-permission-help" id="camera-help" style="display: none;">
                <h4>Camera Access Issues?</h4>
                <ul>
                    <li>Make sure you've allowed camera access when prompted</li>
                    <li>Check if your camera is being used by another application</li>
                    <li>Try refreshing the page and allowing camera access again</li>
                    <li>For mobile devices: ensure you're using HTTPS</li>
                </ul>
            </div>
            
            <div class="scanner-controls">
                <button id="close-scanner" class="btn-secondary">Close</button>
                <button id="toggle-camera" class="btn-secondary">Switch Camera</button>
                <button id="retry-camera" class="btn-primary" style="display: none;">Retry Camera</button>
            </div>
        </div>
    </div>

    <!-- Your existing HTML structure remains the same -->
    <div id="app-container">
        <header class="app-header">
            <h1>Product Expiry Report</h1>
            <a href="../index.html" style="text-decoration: none; display: block; text-align: center; margin-bottom: 25px; color: #0077cc; font-weight: 500;">← العودة إلى لوحة التحكم</a>
            <p>Keep The Records.</p>
        </header>

        <main>
            <section class="card">
                <h2 class="card-title"><span class="material-icons-outlined">search</span>Find an Item</h2>
                <div class="input-group">
                    <input type="text" id="searchBarcodeInput" placeholder="Scan or Enter Barcode...">
                    <button id="searchButton" class="btn-primary" disabled>Search</button>
                    <button id="scanButton" class="btn-secondary" title="Scan Barcode">
                        <span class="material-icons-outlined">qr_code_scanner</span>
                    </button>
                </div>
            </section>

            <!-- Rest of your HTML remains unchanged -->
            <section id="workspace-card" class="card">
                <h2 class="card-title" id="item-title-display"><span class="material-icons-outlined">inventory_2</span>Item Details</h2>
                <ul id="item-details-list"></ul>
                <hr style="border: none; border-top: 1px solid #e9ecef; margin: 24px 0;">
                
                <h3 class="card-title" style="font-size: 1.1rem; margin-bottom: 16px;"><span class="material-icons-outlined">edit_calendar</span>Record Expiry &amp; Quantity</h3>
                <div id="expiry-inputs"></div>
                <div style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap; justify-content: space-between;">
                    <button id="add-expiry-button" class="btn-secondary"><span class="material-icons-outlined">add</span>Add Row</button>
                    <div>
                        <button id="discard-button" class="btn-secondary">Discard</button>
                        <button id="save-button" class="btn-success" disabled><span class="material-icons-outlined">check_circle</span>Save Entry</button>
                    </div>
                </div>
            </section>

            <section class="card">
                <h2 class="card-title"><span class="material-icons-outlined">history</span>Recent Entries</h2>
                <div class="table-wrapper"><table id="records-table"></table></div>
            </section>

            <section class="card">
                <h2 class="card-title"><span class="material-icons-outlined">settings</span>Data Management</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                    <button id="syncButton" class="btn-secondary"><span class="material-icons-outlined">sync</span>Sync Data</button>
                    <button id="exportButton" class="btn-secondary" disabled><span class="material-icons-outlined">download</span>Export & Clear</button>
                </div>
            </section>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script>
        // === CONFIGURATION ===
        const appsScriptUrl = "https://script.google.com/macros/s/AKfycbxYBLxVmDvTN6ggLycCs0uVvAhjoH47azq_8R2Y-uX5fwE6h_YHh7XdvP16J8whC_nx/exec";
        const DATE_FORMAT = "d-m-Y";

        // === GLOBAL VARIABLES ===
        let database = [], currentItem = null, enteredRecords = [];
        let barcodeHeader = '', nameHeader = '';
        let editingRecordIndex = null;
        
        // Barcode scanner variables
        let scannerActive = false;
        let currentStream = null;
        let currentCamera = 'environment';
        let availableCameras = [];
        let currentCameraIndex = 0;

        // === DOM ELEMENT CACHE ===
        const el = { 
            loader: document.getElementById('loader-overlay'), 
            loaderText: document.getElementById('loader-text'), 
            toast: document.getElementById('toast'), 
            searchInput: document.getElementById('searchBarcodeInput'), 
            searchButton: document.getElementById('searchButton'),
            scanButton: document.getElementById('scanButton'),
            workspace: document.getElementById('workspace-card'), 
            itemTitle: document.getElementById('item-title-display'), 
            itemDetails: document.getElementById('item-details-list'), 
            expiryInputs: document.getElementById('expiry-inputs'), 
            addExpiryButton: document.getElementById('add-expiry-button'), 
            discardButton: document.getElementById('discard-button'), 
            saveButton: document.getElementById('save-button'), 
            recordsTable: document.getElementById('records-table'), 
            syncButton: document.getElementById('syncButton'), 
            exportButton: document.getElementById('exportButton'),
            scannerModal: document.getElementById('scanner-modal'),
            scannerVideo: document.getElementById('scanner-video'),
            scannerCanvas: document.getElementById('scanner-canvas'),
            scannerStatus: document.getElementById('scanner-status'),
            closeScanner: document.getElementById('close-scanner'),
            toggleCamera: document.getElementById('toggle-camera'),
            retryCamera: document.getElementById('retry-camera'),
            cameraHelp: document.getElementById('camera-help')
        };
        
        // === UTILITY FUNCTIONS ===
        const showLoader = (msg) => { el.loader.classList.add('visible'); el.loaderText.textContent = msg; };
        const hideLoader = () => el.loader.classList.remove('visible');
        let toastTimeout;
        const showToast = (msg) => { clearTimeout(toastTimeout); el.toast.textContent = msg; el.toast.classList.add('show'); toastTimeout = setTimeout(() => el.toast.classList.remove('show'), 3000); };
        const showWorkspace = (item) => { currentItem = item; el.itemTitle.innerHTML = `<span class="material-icons-outlined">inventory_2</span> ${item[nameHeader] || 'Item Details'}`; const detailsToShow = [nameHeader, barcodeHeader, 'supplier name', 'status'].filter(h => item[h]); el.itemDetails.innerHTML = detailsToShow.map(header => `<li><strong>${header}:</strong> <span>${item[header]}</span></li>`).join(''); el.expiryInputs.innerHTML = ''; addExpiryEntry(); el.workspace.classList.add('visible'); el.saveButton.disabled = false; window.scrollTo({ top: el.workspace.offsetTop - 20, behavior: 'smooth' }); };
        const hideWorkspace = () => { currentItem = null; editingRecordIndex = null; el.workspace.classList.remove('visible'); el.searchInput.value = ''; el.searchInput.focus(); el.saveButton.disabled = true; };
        
        // === BARCODE SCANNER FUNCTIONS ===
        const showScanner = () => {
            el.scannerModal.classList.add('visible');
            el.cameraHelp.style.display = 'none';
            el.retryCamera.style.display = 'none';
            startScanner();
        };
        
        const hideScanner = () => {
            el.scannerModal.classList.remove('visible');
            stopScanner();
        };
        
        const getCameraConstraints = (facingMode) => {
            return {
                video: {
                    facingMode: facingMode,
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            };
        };
        
        const startScanner = async () => {
            try {
                el.scannerStatus.textContent = "Requesting camera access...";
                el.scannerStatus.className = "";
                
                // Stop any existing stream
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
                
                // Try to get available cameras first
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    availableCameras = devices.filter(device => device.kind === 'videoinput');
                    console.log('Available cameras:', availableCameras.length);
                } catch (e) {
                    console.log('Cannot enumerate devices:', e);
                }
                
                // Get camera access with different constraints
                let constraints;
                
                if (availableCameras.length > 1) {
                    // Use deviceId if we have multiple cameras
                    constraints = {
                        video: {
                            deviceId: availableCameras[currentCameraIndex].deviceId,
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    };
                } else {
                    // Fallback to facingMode
                    constraints = getCameraConstraints(currentCamera);
                }
                
                console.log('Using constraints:', constraints);
                
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                if (!currentStream) {
                    throw new Error('No stream received');
                }
                
                el.scannerVideo.srcObject = currentStream;
                
                // Wait for video to be ready
                el.scannerVideo.onloadedmetadata = () => {
                    el.scannerVideo.play().then(() => {
                        scannerActive = true;
                        el.scannerStatus.textContent = "Point camera at barcode";
                        el.scannerStatus.className = "";
                        el.retryCamera.style.display = 'none';
                        el.cameraHelp.style.display = 'none';
                        
                        // Start scanning for barcodes
                        scanBarcode();
                    }).catch(e => {
                        console.error('Video play error:', e);
                        handleCameraError('Video playback failed');
                    });
                };
                
                el.scannerVideo.onerror = (e) => {
                    console.error('Video error:', e);
                    handleCameraError('Video error occurred');
                };
                
            } catch (error) {
                console.error("Error accessing camera:", error);
                handleCameraError(getErrorMessage(error));
            }
        };
        
        const getErrorMessage = (error) => {
            if (error.name === 'NotAllowedError') {
                return 'Camera access was denied. Please allow camera access and try again.';
            } else if (error.name === 'NotFoundError') {
                return 'No camera found on this device.';
            } else if (error.name === 'NotSupportedError') {
                return 'Camera not supported in this browser.';
            } else if (error.name === 'NotReadableError') {
                return 'Camera is already in use by another application.';
            } else {
                return `Camera error: ${error.message || 'Unknown error'}`;
            }
        };
        
        const handleCameraError = (message) => {
            el.scannerStatus.textContent = message;
            el.scannerStatus.className = "error";
            el.retryCamera.style.display = 'inline-flex';
            el.cameraHelp.style.display = 'block';
            scannerActive = false;
        };
        
        const stopScanner = () => {
            scannerActive = false;
            if (currentStream) {
                currentStream.getTracks().forEach(track => {
                    track.stop();
                });
                currentStream = null;
            }
        };
        
        const toggleCamera = async () => {
            if (availableCameras.length <= 1) {
                // Toggle between front and back if we don't have device info
                currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
            } else {
                // Cycle through available cameras
                currentCameraIndex = (currentCameraIndex + 1) % availableCameras.length;
            }
            
            await startScanner();
        };
        
        const scanBarcode = () => {
            if (!scannerActive) return;
            
            const canvas = el.scannerCanvas;
            const video = el.scannerVideo;
            const context = canvas.getContext('2d');
            
            // Check if video is ready
            if (video.readyState !== video.HAVE_ENOUGH_DATA) {
                setTimeout(scanBarcode, 100);
                return;
            }
            
            // Set canvas dimensions to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw current video frame to canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Get image data from canvas
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            
            // Use Quagga to decode barcode
            Quagga.decodeSingle({
                decoder: {
                    readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "upc_reader"]
                },
                locate: true,
                src: imageData.data,
                width: canvas.width,
                height: canvas.height
            }, function(result) {
                if (result && result.codeResult) {
                    const barcode = result.codeResult.code;
                    console.log("Barcode detected:", barcode);
                    
                    // Update status
                    el.scannerStatus.textContent = `Barcode detected: ${barcode}`;
                    el.scannerStatus.className = "success";
                    
                    // Fill the search input and search
                    el.searchInput.value = barcode;
                    setTimeout(() => {
                        hideScanner();
                        handleSearch();
                    }, 1000);
                } else {
                    // Continue scanning
                    if (scannerActive) {
                        setTimeout(scanBarcode, 200);
                    }
                }
            });
        };
        
        // === REST OF YOUR FUNCTIONS REMAIN THE SAME ===
        async function initializeApp() { 
            showLoader('Syncing database...'); 
            loadDataFromLocalStorage(); 
            const inventoryData = await fetchDataFromGoogleSheet(); 
            if (inventoryData?.length) { 
                database = inventoryData; 
                const headers = Object.keys(database[0]); 
                barcodeHeader = headers.find(h => h.toLowerCase().includes('barcode')) || ''; 
                nameHeader = headers.find(h => h.toLowerCase().includes('name')) || ''; 
                if (!barcodeHeader || !nameHeader) { 
                    alert("Data Error: Sheet needs 'barcode' and 'name' columns."); 
                    enableButtons(false); 
                } else { 
                    localStorage.setItem('barcodeHeader', barcodeHeader); 
                    localStorage.setItem('nameHeader', nameHeader); 
                    enableButtons(true); 
                    showToast('Data synced successfully!'); 
                } 
            } else { 
                showToast('Sync failed or database is empty.'); 
                enableButtons(false); 
            } 
            hideLoader(); 
        }
        
        const fetchDataFromGoogleSheet = async () => { 
            if (!appsScriptUrl || appsScriptUrl.includes("PASTE_YOUR")) return null; 
            try { 
                const response = await fetch(appsScriptUrl); 
                return response.ok ? await response.json() : null; 
            } catch (error) { 
                console.error("Fetch Error:", error); 
                return null; 
            } 
        };
        
        const loadDataFromLocalStorage = () => { 
            enteredRecords = JSON.parse(localStorage.getItem('enteredRecords') || '[]'); 
            barcodeHeader = localStorage.getItem('barcodeHeader') || ''; 
            nameHeader = localStorage.getItem('nameHeader') || ''; 
            renderEnteredRecords(); 
        };
        
        const enableButtons = (isEnabled) => { 
            [el.searchButton, el.exportButton, el.scanButton].forEach(btn => btn.disabled = !isEnabled); 
        };
        
        const handleSearch = () => { 
            const barcode = el.searchInput.value.trim(); 
            if (!barcode) return; 
            const foundItem = database.find(item => item[barcodeHeader]?.toString() === barcode); 
            if (foundItem) showWorkspace(foundItem); 
            else showToast('Item not found!'); 
        };
        
        const addExpiryEntry = (date = '', quantity = '') => {
            const div = document.createElement('div');
            div.className = 'expiry-input-group';
            div.innerHTML = `<div class="date-input-wrapper"><input type="text" placeholder="${DATE_FORMAT.replace('Y','yyyy').replace('m','mm').replace('d','dd')}" class="expiry-date" value="${date}"><div class="date-quick-actions"><button type="button" class="quick-date-btn" data-action="today">Today</button><button type="button" class="quick-date-btn" data-action="plus_one_year">+1Y</button></div></div><input type="number" placeholder="Qty" min="1" value="${quantity}"><button type="button" class="btn-secondary btn-icon remove-row-btn" title="Remove row" onclick="this.parentElement.remove()"><span class="material-icons-outlined">delete_outline</span></button>`;
            el.expiryInputs.appendChild(div);
            const dateInput = div.querySelector('.expiry-date');
            const fpInstance = flatpickr(dateInput, { dateFormat: DATE_FORMAT, allowInput: true, minDate: "today" });
            div.querySelectorAll('.quick-date-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const action = btn.dataset.action;
                    let newDate = new Date();
                    if (action === 'plus_one_year') newDate.setFullYear(newDate.getFullYear() + 1);
                    fpInstance.setDate(newDate, true);
                });
            });
            if (!date) dateInput.focus();
        };
        
        const saveEntry = () => {
            const entryNodes = el.expiryInputs.querySelectorAll('.expiry-input-group');
            if (entryNodes.length === 0) return showToast('Please add at least one expiry entry.');

            const recordData = editingRecordIndex !== null ? { ...enteredRecords[editingRecordIndex] } : { ...currentItem };
            
            Object.keys(recordData).forEach(key => {
                if (key.startsWith('expiryDate') || key.startsWith('quantity')) {
                    delete recordData[key];
                }
            });

            for (let i = 0; i < entryNodes.length; i++) {
                const node = entryNodes[i];
                const dateInput = node.querySelector('.expiry-date');
                const qtyInput = node.querySelector('input[type="number"]');
                if (!dateInput.value || !qtyInput.value) return showToast('Please fill all date and quantity fields.');
                recordData[`expiryDate${i + 1}`] = dateInput.value;
                recordData[`quantity${i + 1}`] = parseInt(qtyInput.value, 10);
            }
            recordData.recordTime = new Date().toLocaleString('en-GB');

            if (editingRecordIndex !== null) {
                enteredRecords[editingRecordIndex] = recordData;
                showToast('Entry updated successfully!');
            } else {
                enteredRecords.unshift(recordData);
                showToast(`Entry saved with ${entryNodes.length} expiry date(s)!`);
            }

            localStorage.setItem('enteredRecords', JSON.stringify(enteredRecords));
            renderEnteredRecords();
            hideWorkspace();
        };
        
        const renderEnteredRecords = () => {
            const table = el.recordsTable;
            if (enteredRecords.length === 0) { table.innerHTML = '<tbody><tr><td colspan="5" style="text-align:center; padding: 48px; color: var(--text-secondary);">No entries recorded yet.</td></tr></tbody>'; return; }
            let maxExpiryPairs = 0;
            enteredRecords.forEach(rec => { const keys = Object.keys(rec).filter(k => k.startsWith('expiryDate')); if (keys.length > maxExpiryPairs) maxExpiryPairs = keys.length; });

            let headers = ['Item', 'Barcode'];
            for (let i = 1; i <= maxExpiryPairs; i++) { headers.push(`Expiry ${i}`); headers.push(`Qty ${i}`); }
            headers.push('Actions');
            const head = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
            
            const body = `<tbody>${enteredRecords.map((rec, index) => {
                let rowHtml = `<tr data-index="${index}"><td>${rec[nameHeader] || '–'}</td><td>${rec[barcodeHeader] || '–'}</td>`;
                for (let i = 1; i <= maxExpiryPairs; i++) { rowHtml += `<td>${rec[`expiryDate${i}`] || ''}</td><td>${rec[`quantity${i}`] || ''}</td>`; }
                rowHtml += `<td class="action-cell">
                                <button class="action-btn edit-btn" onclick="handleEdit(${index})"><span class="material-icons-outlined">edit</span></button>
                                <button class="action-btn delete-btn" onclick="handleDelete(${index})"><span class="material-icons-outlined">delete</span></button>
                           </td></tr>`;
                return rowHtml;
            }).join('')}</tbody>`;
            table.innerHTML = head + body;
        };
        
        const handleDelete = (index) => {
            if (confirm(`Are you sure you want to delete the entry for "${enteredRecords[index][nameHeader]}"?`)) {
                enteredRecords.splice(index, 1);
                localStorage.setItem('enteredRecords', JSON.stringify(enteredRecords));
                renderEnteredRecords();
                showToast('Entry deleted.');
            }
        };

        const handleEdit = (index) => {
            editingRecordIndex = index;
            const recordToEdit = enteredRecords[index];
            showWorkspace(recordToEdit);
            el.expiryInputs.innerHTML = '';
            let i = 1;
            while (recordToEdit[`expiryDate${i}`]) {
                addExpiryEntry(recordToEdit[`expiryDate${i}`], recordToEdit[`quantity${i}`]);
                i++;
            }
        };
        
        // === EVENT LISTENERS ===
        document.addEventListener('DOMContentLoaded', initializeApp);
        el.syncButton.addEventListener('click', initializeApp);
        el.searchButton.addEventListener('click', handleSearch);
        el.searchInput.addEventListener('keydown', e => { if (e.key === 'Enter') handleSearch(); });
        el.scanButton.addEventListener('click', showScanner);
        el.addExpiryButton.addEventListener('click', () => addExpiryEntry());
        el.discardButton.addEventListener('click', hideWorkspace);
        el.saveButton.addEventListener('click', saveEntry);
        el.closeScanner.addEventListener('click', hideScanner);
        el.toggleCamera.addEventListener('click', toggleCamera);
        el.retryCamera.addEventListener('click', startScanner);
        el.exportButton.addEventListener('click', () => { 
            if (enteredRecords.length === 0) return showToast('No records to export!'); 
            if (confirm("Export entries to Excel and clear them from this session?")) { 
                const ws = XLSX.utils.json_to_sheet(enteredRecords); 
                const wb = XLSX.utils.book_new(); 
                XLSX.utils.book_append_sheet(wb, ws, 'Inventory Records'); 
                XLSX.writeFile(wb, `inventory_records_${new Date().toISOString().slice(0,10)}.xlsx`); 
                enteredRecords = []; 
                localStorage.setItem('enteredRecords', '[]'); 
                renderEnteredRecords(); 
                showToast("Data exported and cleared."); 
            } 
        });
    </script>
</body>
</html>
